<!DOCTYPE html>
<html>

<head>
    <title>Embedding Correlations</title>
    <script src="https://cdn.plot.ly/plotly-2.29.0.min.js"></script>
    <style>
        body {
            background-color: #1a1a1a;
            color: #ffffff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .container {
            display: flex;
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
        }

        .vertical {
            flex-direction: column;
        }

        .horizontal {
            flex-direction: row;
        }

        .panel {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #plot {
            width: 100%;
            height: 100%;
        }

        #hover-panel {
            background-color: #2a2a2a;
            padding: 20px;
            overflow-y: auto;
        }

        #hover-content {
            display: none;
            /* Hide the hover content div */
        }

        .filtered-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 12px;
            table-layout: fixed;
        }

        .filtered-table th,
        .filtered-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #3a3a3a;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .filtered-table th {
            background-color: #3a3a3a;
            position: sticky;
            top: 0;
        }

        .filtered-table tr:hover {
            background-color: #3a3a3a;
        }

        .filtered-table td:nth-child(1),
        .filtered-table td:nth-child(2) {
            width: 40%;
        }

        .filtered-table td:nth-child(3) {
            width: 20%;
        }

        .controls {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: #2a2a2a;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .button-group {
            display: flex;
            gap: 5px;
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            color: white;
            font-size: 12px;
        }

        .slider-container input {
            width: 100%;
        }

        button {
            background-color: #3a3a3a;
            color: white;
            border: none;
            padding: 8px 12px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #4a4a4a;
        }

        button.active {
            background-color: #5a5a5a;
        }
    </style>
</head>

<body>
    <div class="controls">
        <div class="button-group">
            <button id="single" class="active">Single</button>
            <button id="vertical">Vertical</button>
            <button id="horizontal">Horizontal</button>
        </div>
        <div class="slider-container">
            <label for="threshold">Similarity Threshold: <span id="threshold-value">0.0</span></label>
            <input type="range" id="threshold" min="0" max="1" step="0.01" value="0">
        </div>
    </div>
    <div class="container" id="container">
        <div class="panel">
            <div id="plot"></div>
        </div>
        <div class="panel" id="hover-panel" style="display: none;">
            <table class="filtered-table">
                <thead>
                    <tr>
                        <th>Row</th>
                        <th>Column</th>
                        <th>Similarity</th>
                    </tr>
                </thead>
                <tbody id="filtered-correlations">
                </tbody>
            </table>
        </div>
    </div>
    <script>
        // Helper function to wrap text
        function wrapText(text, maxLen = 50) {
            if (text.length <= maxLen) return text;
            return text.slice(0, maxLen) + '<br>' + wrapText(text.slice(maxLen), maxLen);
        }

        const data = {{ DATA }};
        let nRows = data.rowLabels.length;
        let nCols = data.colLabels.length;

        // Transpose the matrix if rows > columns to better utilize screen space
        let matrix = data.matrix;
        let rowLabels = data.rowLabels;
        let colLabels = data.colLabels;
        let rowFull = data.rowFull;
        let colFull = data.colFull;

        if (nRows > nCols) {
            // Transpose the matrix
            matrix = matrix[0].map((_, i) => matrix.map(row => row[i]));
            [rowLabels, colLabels] = [colLabels, rowLabels];
            [rowFull, colFull] = [colFull, rowFull];
            [nRows, nCols] = [nCols, nRows];
        }

        // Build hover text with full chunk text, wrapped if too long
        const hoverText = [];
        for (let i = 0; i < nRows; i++) {
            hoverText[i] = [];
            for (let j = 0; j < nCols; j++) {
                hoverText[i][j] = `Row: ${wrapText(rowFull[i])}<br>Col: ${wrapText(colFull[j])}<br>Similarity: ${matrix[i][j].toFixed(4)}`;
            }
        }

        // Calculate cell size based on screen dimensions
        function calculateCellSize() {
            const plotContainer = document.getElementById('plot').parentElement;
            const containerWidth = plotContainer.clientWidth;
            const containerHeight = plotContainer.clientHeight;

            return Math.min(
                containerWidth / nCols,
                containerHeight / nRows
            );
        }

        function updatePlotSize() {
            const cellSize = calculateCellSize();
            layout.width = nCols * cellSize;
            layout.height = nRows * cellSize;
            Plotly.relayout('plot', layout);
        }

        const trace = {
            z: matrix,
            x: colLabels,
            y: rowLabels,
            type: 'heatmap',
            colorscale: 'RdBu',
            hoverongaps: false,
            hoverinfo: 'text',
            text: hoverText,
            xgap: 1,
            ygap: 1,
            xmin: 0,
            xmax: 1,
            ymin: 0,
            ymax: 1,
            showscale: false
        };

        // Function to update heatmap based on threshold
        function updateHeatmap(threshold) {
            const filteredMatrix = matrix.map(row =>
                row.map(val => val >= threshold ? val : null)
            );

            // Update hover text to only show for non-filtered cells
            const filteredHoverText = hoverText.map((row, i) =>
                row.map((text, j) => filteredMatrix[i][j] !== null ? text : '')
            );

            // Update the plot
            Plotly.update('plot', {
                z: [filteredMatrix],
                text: [filteredHoverText]
            });

            // Collect all correlations above threshold
            const correlations = [];
            for (let i = 0; i < nRows; i++) {
                for (let j = 0; j < nCols; j++) {
                    if (filteredMatrix[i][j] !== null) {
                        correlations.push({
                            row: rowFull[i],
                            col: colFull[j],
                            similarity: filteredMatrix[i][j]
                        });
                    }
                }
            }

            // Sort by similarity in ascending order and take bottom 100
            correlations.sort((a, b) => a.similarity - b.similarity);
            const bottomCorrelations = correlations.slice(0, 100);

            // Update the filtered correlations table
            const tbody = document.getElementById('filtered-correlations');
            tbody.innerHTML = '';

            bottomCorrelations.forEach(corr => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td title="${corr.row}">${corr.row}</td>
                    <td title="${corr.col}">${corr.col}</td>
                    <td>${corr.similarity.toFixed(4)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        const layout = {
            paper_bgcolor: '#1a1a1a',
            plot_bgcolor: '#1a1a1a',
            font: { color: '#ffffff' },
            xaxis: {
                showticklabels: false,
                showgrid: false,
                zeroline: false,
                autorange: true,
                fixedrange: true,
                showline: false
            },
            yaxis: {
                showticklabels: false,
                showgrid: false,
                zeroline: false,
                autorange: 'reversed',
                fixedrange: true,
                showline: false
            },
            autosize: true,
            margin: { l: 0, r: 0, t: 0, b: 0 },
            width: nCols * calculateCellSize(),
            height: nRows * calculateCellSize(),
            yaxis_scaleanchor: 'x',
            yaxis_scaleratio: 1
        };

        Plotly.newPlot('plot', [trace], layout, { responsive: true });

        // Handle window resize
        window.addEventListener('resize', updatePlotSize);

        // Handle hover events
        document.getElementById('plot').on('plotly_hover', function (data) {
            // Remove hover text handling since we don't need it anymore
        });

        // Handle layout switching
        const container = document.getElementById('container');
        const hoverPanel = document.getElementById('hover-panel');
        const buttons = document.querySelectorAll('.controls button');

        function setLayout(layout) {
            buttons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(layout).classList.add('active');

            container.className = 'container';
            hoverPanel.style.display = 'none';

            if (layout === 'vertical') {
                container.classList.add('vertical');
                hoverPanel.style.display = 'block';
            } else if (layout === 'horizontal') {
                container.classList.add('horizontal');
                hoverPanel.style.display = 'block';
            }

            // Update plot size after layout change
            setTimeout(updatePlotSize, 0);
        }

        buttons.forEach(button => {
            button.addEventListener('click', () => setLayout(button.id));
        });

        // Add threshold slider event listener
        const thresholdSlider = document.getElementById('threshold');
        const thresholdValue = document.getElementById('threshold-value');

        thresholdSlider.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            thresholdValue.textContent = value.toFixed(2);
            updateHeatmap(value);
        });
    </script>
</body>

</html>